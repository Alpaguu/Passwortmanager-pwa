<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passwort-Konverter</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }
        .step h3 {
            color: #1e40af;
            margin-top: 0;
        }
        .format-example {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .file-input {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fafb;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .file-input:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .file-input input {
            display: none;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #6b7280;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-success:hover {
            background: #059669;
        }
        .output {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        .output h4 {
            margin-top: 0;
            color: #374151;
        }
        .download-section {
            text-align: center;
            margin-top: 20px;
        }
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .format-selector {
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .format-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .format-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Passwort-Konverter</h1>
        
        <div class="step">
            <h3>Schritt 1: W√§hle dein Textformat</h3>
            <p>W√§hle aus, wie deine Passw√∂rter in der Textdatei formatiert sind:</p>
            
            <div class="format-selector">
                <label for="formatSelect">Format ausw√§hlen:</label>
                <select id="formatSelect">
                    <option value="block">Block-Format: Titel + Benutzer + Passwort (f√ºr deine Datei)</option>
                    <option value="inline">Inline-Format: Titel Name Passwort in einer Zeile</option>
                    <option value="custom">Benutzerdefiniert (selbst definieren)</option>
                    <option value="simple">Einfach: Titel | Benutzername | Passwort</option>
                    <option value="detailed">Detailliert: Titel | Benutzername | Passwort | URL | Notizen</option>
                    <option value="csv">CSV-Format (Komma-getrennt)</option>
                </select>
            </div>
        </div>

        <div class="step">
            <h3>Schritt 2: Lade deine Textdatei hoch</h3>
            <p>Lade die Textdatei mit deinen Passw√∂rtern hoch:</p>
            
            <div class="file-input" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept=".txt,.csv" onchange="handleFileSelect(event)">
                <p>üìÅ Klicke hier, um eine Datei auszuw√§hlen</p>
                <p style="font-size: 14px; color: #6b7280;">Unterst√ºtzt: .txt, .csv</p>
            </div>
        </div>

        <div class="step">
            <h3>Schritt 3: Konvertiere und lade herunter</h3>
            <p>Nach dem Hochladen kannst du die konvertierte JSON-Datei herunterladen:</p>
            
            <button class="btn" id="convertBtn" onclick="convertFile()" disabled>Datei konvertieren</button>
            <button class="btn btn-secondary" onclick="downloadTemplate()">Template herunterladen</button>
            
            <div style="margin-top: 15px;">
                <label for="exportFormat">Export-Format:</label>
                <select id="exportFormat" style="margin-left: 10px; padding: 5px;">
                    <option value="passwortmanager">Passwort-Manager Format (unverschl√ºsselt)</option>
                    <option value="passwortmanager_encrypted">Passwort-Manager Format (verschl√ºsselt)</option>
                    <option value="simple">Einfach (nur Basis-Felder)</option>
                    <option value="full">Vollst√§ndig (mit Zeitstempel)</option>
                    <option value="csv">CSV-Format</option>
                </select>
            </div>
        </div>

        <div id="output" class="output">
            <h4>Konvertierte Daten:</h4>
            <div id="outputContent"></div>
            <div class="download-section">
                <button class="btn btn-success" onclick="downloadJSON()">JSON-Datei herunterladen</button>
            </div>
        </div>

        <div class="step">
            <h3>üìã Beispiele f√ºr Textformate</h3>
            
            <h4>Inline-Format (f√ºr deine Datei):</h4>
            <div class="format-example">
test titel 1 test name 1 test Passwort 1
test titel 2 test name 2 test Passwort 2
test titel 3 test name 3 test Passwort 3
            </div>
            
            <h4>Block-Format (f√ºr deine Datei):</h4>
            <div class="format-example">
EMAIL
Parfumbusiness@outlook.de
Canmert658?

TRELLO
Parfumbusiness@outlook.de
Canparf√ºm123!
            </div>
            
            <h4>Einfaches Format:</h4>
            <div class="format-example">
Facebook | meine.email@example.com | meinpasswort123
Gmail | meine.email@gmail.com | gmailpasswort
            </div>
            
            <h4>Detailliertes Format:</h4>
            <div class="format-example">
Facebook | meine.email@example.com | meinpasswort123 | https://facebook.com | Pers√∂nlicher Account
Gmail | meine.email@gmail.com | gmailpasswort | https://mail.google.com | Haupt-E-Mail
            </div>
            
            <h4>CSV-Format:</h4>
            <div class="format-example">
title,username,password,url,notes
Facebook,meine.email@example.com,meinpasswort123,https://facebook.com,Pers√∂nlicher Account
Gmail,meine.email@gmail.com,gmailpasswort,https://mail.google.com,Haupt-E-Mail
            </div>
        </div>
    </div>

    <script>
        let fileContent = '';
        let convertedData = [];
        let selectedFormat = 'custom';

        document.getElementById('formatSelect').onchange = function() {
            selectedFormat = this.value;
        };

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                fileContent = e.target.result;
                document.getElementById('convertBtn').disabled = false;
                
                // Zeige Vorschau
                showFilePreview(fileContent);
            };
            reader.readAsText(file);
        }

        function showFilePreview(content) {
            const lines = content.split('\n').slice(0, 5); // Zeige nur die ersten 5 Zeilen
            const preview = lines.map(line => line.trim()).filter(line => line).join('\n');
            
            if (preview) {
                const output = document.getElementById('output');
                const outputContent = document.getElementById('outputContent');
                outputContent.innerHTML = `
                    <div class="success">
                        <strong>Datei erfolgreich geladen!</strong><br>
                        <strong>Vorschau (erste 5 Zeilen):</strong><br>
                        <pre style="background: white; padding: 10px; border-radius: 4px; margin-top: 10px;">${preview}</pre>
                    </div>
                `;
                output.style.display = 'block';
            }
        }

        function convertFile() {
            if (!fileContent) {
                alert('Bitte lade zuerst eine Datei hoch.');
                return;
            }

            try {
                console.log('=== STARTING CONVERSION ===');
                console.log('Selected format:', selectedFormat);
                console.log('File content:', fileContent);
                
                const lines = fileContent.split('\n');
                console.log('Split lines:', lines);
                convertedData = [];

                if (selectedFormat === 'block') {
                    // Spezielle Behandlung f√ºr Block-Format
                    console.log('Processing block format with', lines.length, 'lines');
                    let currentBlock = [];
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        console.log(`Line ${i + 1}: "${line}"`);
                        
                        if (line) {
                            currentBlock.push(line);
                            console.log(`Added to current block. Block now has ${currentBlock.length} lines:`, currentBlock);
                        } else if (currentBlock.length > 0) {
                            // Leere Zeile gefunden - verarbeite den aktuellen Block
                            console.log(`Empty line found. Processing block with ${currentBlock.length} lines:`, currentBlock);
                            const entry = processBlock(currentBlock);
                            if (entry) {
                                convertedData.push(entry);
                                console.log(`Block processed successfully. Total entries: ${convertedData.length}`);
                            } else {
                                console.log(`Block processing failed for:`, currentBlock);
                            }
                            currentBlock = [];
                        }
                    }
                    
                    // Verarbeite den letzten Block, falls vorhanden
                    if (currentBlock.length > 0) {
                        console.log(`Processing final block with ${currentBlock.length} lines:`, currentBlock);
                        const entry = processBlock(currentBlock);
                        if (entry) {
                            convertedData.push(entry);
                            console.log(`Final block processed successfully. Total entries: ${convertedData.length}`);
                        } else {
                            console.log(`Final block processing failed for:`, currentBlock);
                        }
                    }
                } else if (selectedFormat === 'inline') {
                    // Neue Behandlung f√ºr Inline-Format (alle Daten in einer Zeile)
                    console.log('Processing inline format with', lines.length, 'lines');
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        console.log(`Processing line ${i + 1}:`, line);
                        const entries = processInlineFormat(line);
                        console.log(`Line ${i + 1} produced entries:`, entries);
                        
                        if (entries && entries.length > 0) {
                            convertedData.push(...entries);
                            console.log(`Added ${entries.length} entries, total now:`, convertedData.length);
                        }
                    }
                } else {
                    // Normale Verarbeitung f√ºr andere Formate
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        let passwordEntry;
                        
                        switch (selectedFormat) {
                            case 'simple':
                                passwordEntry = parseSimpleFormat(line);
                                break;
                            case 'detailed':
                                passwordEntry = parseDetailedFormat(line);
                                break;
                            case 'csv':
                                passwordEntry = parseCSVFormat(line);
                                break;
                            default:
                                passwordEntry = parseCustomFormat(line);
                        }

                        if (passwordEntry) {
                            convertedData.push(passwordEntry);
                        }
                    }
                }

                if (convertedData.length === 0) {
                    // Fallback: Versuche es mit einer einfacheren Methode
                    console.log('No entries found, trying fallback method...');
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Einfache Aufteilung nach Leerzeichen
                        const words = line.split(/\s+/);
                        if (words.length >= 3) {
                            // Erstelle Eintr√§ge f√ºr jede 3er-Gruppe
                            for (let j = 0; j < words.length - 2; j += 3) {
                                const title = words[j];
                                const username = words[j + 1];
                                const password = words[j + 2];
                                
                                if (title && username && password) {
                                    convertedData.push({
                                        title: title,
                                        username: username,
                                        password: password,
                                        url: '',
                                        notes: '',
                                        folderId: null,
                                        createdAt: new Date().toISOString(),
                                        updatedAt: new Date().toISOString()
                                    });
                                    console.log('Fallback entry created:', { title, username, password });
                                }
                            }
                        }
                    }
                    
                    if (convertedData.length === 0) {
                        throw new Error('Keine g√ºltigen Passwort-Eintr√§ge gefunden. Bitte √ºberpr√ºfe das Format deiner Datei.');
                    }
                }

                showConversionResult();
            } catch (error) {
                showError('Fehler beim Konvertieren: ' + error.message);
            }
        }

        function parseSimpleFormat(line) {
            const parts = line.split('|').map(part => part.trim());
            if (parts.length >= 3) {
                return {
                    title: parts[0],
                    username: parts[1],
                    password: parts[2],
                    url: '',
                    notes: '',
                    folderId: null
                };
            }
            return null;
        }

        function parseDetailedFormat(line) {
            const parts = line.split('|').map(part => part.trim());
            if (parts.length >= 3) {
                return {
                    title: parts[0],
                    username: parts[1],
                    password: parts[2],
                    url: parts[3] || '',
                    notes: parts[4] || '',
                    folderId: null
                };
            }
            return null;
        }

        function parseCSVFormat(line) {
            // √úberspringe Header-Zeile
            if (line.toLowerCase().includes('title,username,password')) {
                return null;
            }
            
            const parts = line.split(',').map(part => part.trim());
            if (parts.length >= 3) {
                return {
                    title: parts[0],
                    username: parts[1],
                    password: parts[2],
                    url: parts[3] || '',
                    notes: parts[4] || '',
                    folderId: null
                };
            }
            return null;
        }

        function processBlock(blockLines) {
            if (blockLines.length < 3) return null; // Mindestens Titel, Benutzer und Passwort
            
            const title = blockLines[0];
            const username = blockLines[1];
            const password = blockLines[2];
            const notes = blockLines.slice(3).join('\n');
            
            console.log('Processing block:', { title, username, password, notes });
            
            // Pr√ºfe ob es g√ºltige Daten sind
            if (title && username && password) {
                return {
                    title: title,
                    username: username,
                    password: password,
                    url: '',
                    notes: notes || '',
                    folderId: null,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
            }
            
            return null;
        }

        function processInlineFormat(line) {
            try {
                console.log('Processing line:', line);
                
                // Verarbeite Zeilen, wo alle Daten in einer Zeile mit Leerzeichen getrennt sind
                const parts = line.split(/\s+/).filter(part => part.trim());
                console.log('Split parts:', parts);
                
                const entries = [];
                
                // Intelligente Gruppierung: Kombiniere zusammengeh√∂rige W√∂rter
                for (let i = 0; i < parts.length; i += 6) { // Jeder Eintrag braucht 6 W√∂rter
                    if (i + 5 < parts.length) {
                        // Gruppiere: "test titel 1" + "test name 1" + "test Passwort 1"
                        const title = parts[i] + ' ' + parts[i + 1] + ' ' + parts[i + 2];
                        const username = parts[i + 3] + ' ' + parts[i + 4];
                        const password = parts[i + 5];
                        
                        console.log(`Creating entry ${Math.floor(i/6) + 1}:`, { title, username, password });
                        
                        // Pr√ºfe ob alle Felder g√ºltig sind
                        if (title && username && password && 
                            title.length > 0 && username.length > 0 && password.length > 0) {
                            entries.push({
                                title: title,
                                username: username,
                                password: password,
                                url: '',
                                notes: '',
                                folderId: null,
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            });
                            console.log(`Entry ${Math.floor(i/6) + 1} added successfully`);
                        } else {
                            console.log(`Entry ${Math.floor(i/6) + 1} invalid:`, { title, username, password });
                        }
                    }
                }
                
                console.log('Total entries created:', entries.length);
                return entries.length > 0 ? entries : null;
            } catch (error) {
                console.error('Error in processInlineFormat:', error);
                return null;
            }
        }

        function parseCustomFormat(line) {
            // Versuche verschiedene Trennzeichen zu erkennen
            const separators = ['|', ';', '\t', ','];
            
            for (const separator of separators) {
                const parts = line.split(separator).map(part => part.trim());
                if (parts.length >= 3) {
                    return {
                        title: parts[0],
                        username: parts[1],
                        password: parts[2],
                        url: parts[3] || '',
                        notes: parts[4] || '',
                        folderId: null
                    };
                }
            }
            
            return null;
        }

        function showConversionResult() {
            const outputContent = document.getElementById('outputContent');
            outputContent.innerHTML = `
                <div class="success">
                    <strong>‚úÖ Konvertierung erfolgreich!</strong><br>
                    <strong>${convertedData.length} Passwort-Eintr√§ge gefunden.</strong>
                </div>
                <div style="margin-top: 15px;">
                    <strong>Beispiel-Eintr√§ge:</strong><br>
                    <pre style="background: white; padding: 10px; border-radius: 4px; margin-top: 10px; max-height: 200px; overflow-y: auto;">${JSON.stringify(convertedData.slice(0, 3), null, 2)}</pre>
                </div>
            `;
        }

        function showError(message) {
            const outputContent = document.getElementById('outputContent');
            outputContent.innerHTML = `<div class="error">${message}</div>`;
        }

        async function downloadJSON() {
            if (convertedData.length === 0) {
                alert('Keine Daten zum Herunterladen vorhanden.');
                return;
            }

            const exportFormat = document.getElementById('exportFormat').value;
            let dataToExport = convertedData;
            let fileName = 'passwoerter_import.json';
            let mimeType = 'application/json';

            if (exportFormat === 'simple') {
                // Nur die wichtigsten Felder f√ºr den Import
                dataToExport = convertedData.map(entry => ({
                    title: entry.title,
                    username: entry.username,
                    password: entry.password,
                    url: entry.url,
                    notes: entry.notes,
                    folderId: entry.folderId
                }));
            } else if (exportFormat === 'passwortmanager') {
                // Spezielles Format f√ºr deinen Passwort-Manager (unverschl√ºsselt)
                dataToExport = {
                    passwords: convertedData.map(entry => ({
                        title: entry.title,
                        username: entry.username,
                        password: entry.password,
                        url: entry.url,
                        notes: entry.notes,
                        folderId: entry.folderId,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    })),
                    folders: []
                };
                fileName = 'passwoerter_import.json';
                mimeType = 'application/json';
            } else if (exportFormat === 'passwortmanager_encrypted') {
                // Verschl√ºsseltes Format f√ºr deinen Passwort-Manager
                const masterPassword = prompt('Master-Passwort f√ºr Verschl√ºsselung eingeben:');
                if (!masterPassword) {
                    alert('Verschl√ºsselung abgebrochen. Verwende unverschl√ºsseltes Format.');
                    return;
                }
                
                // Einfache Verschl√ºsselung (f√ºr Demo-Zwecke)
                const dataToEncrypt = {
                    passwords: convertedData.map(entry => ({
                        title: entry.title,
                        username: entry.username,
                        password: entry.password,
                        url: entry.url,
                        notes: entry.notes,
                        folderId: entry.folderId,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    })),
                    folders: []
                };
                
                // Verschl√ºssele die Daten
                const encryptedData = await encryptData(dataToEncrypt, masterPassword);
                dataToExport = encryptedData;
                fileName = 'passwoerter_import_encrypted.json';
                mimeType = 'application/json';
            } else if (exportFormat === 'csv') {
                // CSV-Format
                const csvHeader = 'title,username,password,url,notes,folderId\n';
                const csvData = dataToExport.map(entry => 
                    `"${entry.title}","${entry.username}","${entry.password}","${entry.url}","${entry.notes}","${entry.folderId || ''}"`
                ).join('\n');
                dataToExport = csvHeader + csvData;
                fileName = 'passwoerter_import.csv';
                mimeType = 'text/csv';
            }

            let dataStr;
            if (exportFormat === 'csv') {
                dataStr = dataToExport;
            } else {
                dataStr = JSON.stringify(dataToExport, null, 2);
            }

            const dataBlob = new Blob([dataStr], {type: mimeType});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = fileName;
            link.click();
        }

        // Einfache Verschl√ºsselungsfunktionen
        async function encryptData(data, password) {
            try {
                // Generiere einen zuf√§lligen Salt
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const saltHex = Array.from(salt).map(b => b.toString(16).padStart(2, '0')).join('');
                
                // Generiere einen zuf√§lligen IV
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const ivHex = Array.from(iv).map(b => b.toString(16).padStart(2, '0')).join('');
                
                // Konvertiere Passwort zu Key
                const encoder = new TextEncoder();
                const passwordBuffer = encoder.encode(password);
                const saltBuffer = encoder.encode(saltHex);
                
                // Einfache Key-Derivation (f√ºr Demo-Zwecke)
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    new Uint8Array([...passwordBuffer, ...saltBuffer]),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: saltBuffer,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt']
                );
                
                // Verschl√ºssele die Daten
                const dataString = JSON.stringify(data);
                const dataBuffer = encoder.encode(dataString);
                const encryptedBuffer = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    dataBuffer
                );
                
                // Konvertiere zu Hex
                const encryptedHex = Array.from(new Uint8Array(encryptedBuffer))
                    .map(b => b.toString(16).padStart(2, '0')).join('');
                
                return {
                    encrypted: encryptedHex,
                    iv: ivHex,
                    salt: saltHex
                };
            } catch (error) {
                console.error('Verschl√ºsselungsfehler:', error);
                throw new Error('Verschl√ºsselung fehlgeschlagen: ' + error.message);
            }
        }

        function downloadTemplate() {
            const template = `Facebook
meine.email@example.com
meinpasswort123
Pers√∂nlicher Account

Gmail
meine.email@gmail.com
gmailpasswort
Haupt-E-Mail Account

Amazon
meine.email@amazon.com
amazonpasswort
Online-Shopping Account

PayPal
meine.email@paypal.com
paypalpasswort
Zahlungsdienst`;

            const dataBlob = new Blob([template], {type: 'text/plain'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'passwort_template.txt';
            link.click();
        }
    </script>
</body>
</html>
